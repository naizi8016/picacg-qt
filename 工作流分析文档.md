# GitHub Actions Release 工作流分析

## 1. 工作流概述

`release.yml` 是一个用于自动化构建和发布 picacg-qt 项目的 GitHub Actions 工作流文件。该工作流能够根据不同平台和配置需求，自动构建应用程序并发布到 GitHub Release 页面。

## 2. 工作流触发条件

工作流在以下两种情况下触发：

```yaml
on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      # 各种构建选项...
```

1. **自动触发**：当项目仓库有新的 Git tag 被推送时
2. **手动触发**：通过 GitHub 界面手动触发，可选择构建哪些平台版本

## 3. 主要工作流程结构

整个工作流由多个作业（jobs）组成，采用依赖关系组织：

1. **setup**：基础设置作业，为其他作业提供版本信息
2. **release**：创建 GitHub Release 草稿
3. **构建作业**：为不同平台和配置创建构建作业
   - macOS 相关：macos, macos-nosr
   - Windows 相关：windows, windows-nosr, windows7, windows7-nosr
   - Linux 相关：linux-arm64-nosr

## 4. 关键作业详解

### 4.1 setup 作业

```yaml
setup:
  runs-on: ubuntu-latest
  outputs:
    PACKAGE_PREFIX: ${{ steps.get-package_prefix.outputs.PACKAGE_PREFIX }}
    TAG_NAME: ${{ steps.get-package_prefix.outputs.TAG_NAME }}
    HEAD_SHA_SHORT: ${{ steps.get-package_prefix.outputs.HEAD_SHA_SHORT }}
  steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: '0'
    - name: get-package_prefix
      id: get-package_prefix
      run: |
        LIB_NAME=bika
        TAG_NAME=$(git describe --abbrev=0 --tags)
        HEAD_SHA_SHORT=$(git rev-parse --short HEAD)
        echo "::set-output name=PACKAGE_PREFIX::${LIB_NAME}_${TAG_NAME}"
        echo "::set-output name=TAG_NAME::${TAG_NAME}"
        echo "::set-output name=HEAD_SHA_SHORT::${HEAD_SHA_SHORT}"
```

**主要功能**：
- 在 Ubuntu 环境运行
- 检出代码仓库
- 获取当前 Git tag 名称和短 SHA 值
- 设置输出变量，供后续作业使用
  - PACKAGE_PREFIX：包名前缀，格式为 `bika_<tag_name>`
  - TAG_NAME：当前 Git tag 名称
  - HEAD_SHA_SHORT：当前提交的短 SHA 值

### 4.2 release 作业

```yaml
release:
  needs: [setup]
  runs-on: ubuntu-latest
  outputs:
    Up_Url: ${{ steps.create_release.outputs.upload_url }}
  steps:
    - name: create_release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.setup.outputs.TAG_NAME }}
        release_name: ${{ needs.setup.outputs.TAG_NAME }}
        draft: true
        prerelease: true
```

**主要功能**：
- 依赖于 setup 作业的完成
- 创建一个 GitHub Release 草稿
- 设置输出变量 Up_Url，为后续上传构建产物提供 URL

## 5. build_windows 工作流详细分析

### 5.1 build_windows 参数说明

```yaml
inputs:
  build_windows:
    description: '打包 Windows x64'
    type: boolean
    default: true
```

这个输入参数用于控制是否构建 Windows x64 版本，默认值为 true。

### 5.2 windows 作业实现

```yaml
windows:
  if: github.event_name == 'push' || github.event.inputs.build_windows == 'true'
  needs: [setup, release]
  runs-on: windows-latest
  env:
    PACKAGENAME: ${{ needs.setup.outputs.PACKAGE_PREFIX }}_windows_x64
    EXE_NAME: PicACG.exe
  steps:
    # 详细步骤...
```

**执行条件**：
- 当有新 tag 推送时自动执行
- 或手动触发且 build_windows 参数为 true 时执行
- 依赖于 setup 和 release 作业的完成

**执行环境**：
- 在 GitHub 的 windows-latest  runners 上执行
- 设置环境变量：
  - PACKAGENAME：包名，格式为 `${PACKAGE_PREFIX}_windows_x64`
  - EXE_NAME：输出的可执行文件名，为 PicACG.exe

### 5.3 build_windows 执行步骤详解

#### 5.3.1 代码检出与环境设置

```yaml
- uses: actions/checkout@v4
- name: Set up Python 3.10
  uses: actions/setup-python@v5
  with:
    python-version: '3.10'
```

- 检出项目代码
- 安装并配置 Python 3.10 环境

#### 5.3.2 安装构建依赖

```yaml
- name: Install build dependencies
  run: |
    python -m pip install --upgrade pip
    pip install nuitka
    pip install https://github.com/tonquer/waifu2x-vulkan/releases/download/v1.1.6/sr_ncnn_vulkan-1.2.0-cp36.cp37.cp38.cp39.cp310.cp311-none-win_amd64.whl
    pip install -r src\requirements.txt
    Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v5.0.1/upx-5.0.1-win64.zip" -OutFile "upx.zip"
    Expand-Archive -Path "upx.zip" -DestinationPath "D:\"
    Remove-Item "upx.zip"
```

- 升级 pip 到最新版本
- 安装 Nuitka（Python 编译器，用于构建可执行文件）
- 安装 sr_ncnn_vulkan（用于图片超分辨率处理的库）
- 安装项目依赖（从 requirements.txt）
- 下载并解压 UPX（用于压缩可执行文件）

#### 5.3.3 构建应用程序

```yaml
- name: Build
  run: |
    cd src
    Invoke-WebRequest -Uri "https://github.com/bika-robot/picacg-database/releases/download/v1.5.3/book.db" -OutFile "db\book.db"
    Copy-Item ..\res\icon\icon.ico .
    python -m nuitka `
      --onefile `
      --onefile-no-compression `
      --output-dir=dist `
      --output-filename=PicACG `
      --windows-console-mode=disable `
      --msvc=latest `
      --clang `
      --assume-yes-for-downloads `
      --windows-icon-from-ico=icon.ico `
      --plugin-enable=pyside6,upx --upx-binary="D:\upx-5.0.1-win64" `
      start.py
    
    $pkg = "bika"
    Remove-Item -Recurse -Force $pkg -ErrorAction SilentlyContinue
    New-Item $pkg -ItemType Directory
    Move-Item "dist\$env:EXE_NAME" "$pkg\start.exe"
    Copy-Item -Recurse db               $pkg\
    Copy-Item ..\LICENSE                $pkg\
    Copy-Item ..\CHANGELOG              $pkg\
    7z a -t7z -mx9 "$env:PACKAGENAME.7z" $pkg
    Move-Item "${env:PACKAGENAME}.7z" ..\
    cd ..
```

**构建过程详解**：
1. 进入 src 目录
2. 下载最新的数据库文件 book.db
3. 复制应用程序图标文件
4. 使用 Nuitka 编译 Python 代码：
   - 生成单个可执行文件
   - 禁用控制台模式（GUI 应用）
   - 使用最新的 MSVC 和 Clang 编译器
   - 指定应用图标
   - 启用 pyside6 和 upx 插件
5. 创建发布目录结构：
   - 创建 bika 目录
   - 将编译好的可执行文件移动到该目录并重命名为 start.exe
   - 复制数据库目录 db
   - 复制 LICENSE 和 CHANGELOG 文件
6. 使用 7-Zip 创建高压缩率的 7z 归档文件
7. 将归档文件移动到项目根目录

#### 5.3.4 上传构建产物

```yaml
- name: Upload artifact
  uses: actions/upload-artifact@v4
  with:
    name: ${{ env.PACKAGENAME }}
    path: ${{ env.PACKAGENAME }}.7z

- name: upload-win
  uses: actions/upload-release-asset@v1
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  with:
    upload_url:         ${{ needs.release.outputs.Up_Url }}
    asset_path:         ${{ env.PACKAGENAME }}.7z
    asset_name:         ${{ env.PACKAGENAME }}.7z
    asset_content_type: application/x-7z-compressed
```

- 将构建产物上传为 GitHub Actions 工作流 artifact
- 将构建产物上传到之前创建的 GitHub Release 草稿中

## 6. 其他 Windows 相关构建作业

除了标准的 Windows x64 构建外，工作流还包含其他 Windows 相关的构建作业：

### 6.1 windows-nosr

- 构建不带图片超分功能（no super resolution）的 Windows x64 版本
- 不安装 sr_ncnn_vulkan 库
- 其余步骤与 windows 作业类似

### 6.2 windows7 和 windows7-nosr

- 专门为 Windows 7 x64 系统构建的版本
- 使用 Python 3.8 而非 3.10
- 使用 pyinstaller 而非 nuitka 进行打包
- 其他特点与标准 Windows 版本类似

## 7. 工作流执行流程图

整个工作流的执行流程可以概括为：

1. **触发阶段**：通过 git tag 推送或手动触发
2. **准备阶段**：
   - setup：获取版本信息
   - release：创建 GitHub Release 草稿
3. **构建阶段**：根据触发条件和输入参数，并行执行多个平台的构建作业
   - 每个构建作业完成代码检出、环境配置、依赖安装、构建和打包
4. **发布阶段**：
   - 每个构建作业将产物上传为 artifact
   - 每个构建作业将产物上传到 GitHub Release

## 8. 关键技术点分析

### 8.1 多平台构建策略

- 使用不同的 GitHub Actions runners 构建不同平台的版本
- 为每个平台选择最适合的打包工具：
  - Windows：Nuitka/pyinstaller
  - macOS：pyinstaller + create-dmg
  - Linux：Nuitka（通过 Docker 容器）

### 8.2 条件执行控制

- 使用 if 条件控制每个构建作业的执行
- 通过 workflow_dispatch inputs 提供灵活的手动构建选项
- 使用 needs 定义作业间的依赖关系

### 8.3 产物管理

- 统一的包命名规则，包含版本信息和平台标识
- 构建产物同时作为 artifact 和 Release asset 上传，便于测试和正式发布

## 9. 代码优化建议

### 9.1 工作流优化

1. **减少重复代码**
   - 各个平台构建作业存在大量重复代码，建议使用 GitHub Actions 的矩阵策略（matrix）或可重用工作流来减少重复
   - 示例：
   ```yaml
   jobs:
     build:
       runs-on: ${{ matrix.os }}
       strategy:
         matrix:
           os: [windows-latest, macos-latest, ubuntu-latest]
           include:
             - os: windows-latest
               python-version: '3.10'
               # 其他平台特定配置...
   ```

2. **统一依赖管理**
   - 考虑使用 Poetry 或 Pipenv 等工具进行依赖管理，避免在构建脚本中直接安装依赖
   - 将版本号等配置集中管理，减少硬编码

### 9.2 构建过程优化

1. **缓存机制**
   - 添加依赖缓存步骤，减少重复下载
   ```yaml
   - name: Cache Python dependencies
     uses: actions/cache@v3
     with:
       path: ~\AppData\Local\pip\Cache
       key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
       restore-keys: |
         ${{ runner.os }}-pip-
   ```

2. **并行构建优化**
   - 考虑将耗时较长但相互独立的步骤并行执行，提高构建效率

3. **错误处理增强**
   - 添加更完善的错误处理和日志记录，便于调试构建失败的情况