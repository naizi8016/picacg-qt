# 本地构建指南

本文档基于 `.github/workflows/release.yml` 文件中的 Windows 构建工作流配置，逆向解析出在本地环境构建所需的全部依赖项、工具版本、环境变量及系统配置，帮助您摆脱对 GitHub Actions 的依赖，在本地成功构建项目。

## 一、系统要求

- **操作系统**：Windows 10/11 x64
- **磁盘空间**：至少 2GB 可用空间
- **内存**：建议 4GB 以上

## 二、必要工具安装

### 1. Python

- **版本**：Python 3.10.x
- **安装说明**：从 [Python 官网](https://www.python.org/downloads/windows/) 下载并安装
- **环境配置**：确保将 Python 和 pip 添加到系统环境变量 PATH 中

### 2. Nuitka（打包工具）

- **安装命令**：使用Python 3.10.16的完整路径执行pip命令
  ```powershell
  C:\Users\wumingjie\python-sdk\python3.10.16\python.exe -m pip install --upgrade pip
  C:\Users\wumingjie\python-sdk\python3.10.16\python.exe -m pip install nuitka
  ```

  **注意**：如果已在VSCode中配置了Python 3.10.16作为默认解释器，也可以直接使用：
  ```powershell
  python -m pip install --upgrade pip
  python -m pip install nuitka
  ```

### 3. UPX（可执行文件压缩工具）

- **版本**：5.0.1
- **下载地址**：https://github.com/upx/upx/releases/download/v5.0.1/upx-5.0.1-win64.zip
- **安装说明**：下载后解压到任意位置（如 `D:\upx-5.0.1-win64`）

### 4. 7-Zip（压缩工具）

- **要求**：确保系统已安装 7-Zip 并添加到环境变量 PATH 中

### 5. Visual Studio Build Tools

- **要求**：Nuitka 需要使用 MSVC 编译器
- **安装建议**：安装 Visual Studio Build Tools 或完整的 Visual Studio，确保包含以下工作负荷：
  - **使用C++的桌面开发**：这个工作负荷会包含MSVC编译器，是Nuitka构建所必需的
  - **C++ Clang编译器**：如果有单独的Clang组件选项，也请选择安装，因为构建命令中使用了Clang
  
  根据您提供的截图，在Visual Studio Installer中，请选择"使用C++的桌面开发"工作负荷（在"桌面应用和移动应用"分类下）

### 6. Clang（可选但推荐）

- **要求**：Nuitka 配置中使用了 Clang 编译器
- **安装说明**：可通过 Visual Studio 安装或单独安装 Clang

## 三、项目依赖安装

### 1. 基础依赖

首先安装项目源代码目录 `src` 下的 requirements.txt 中列出的依赖：

使用Python 3.10.16的完整路径执行：
```powershell
cd c:\Users\wumingjie\Documents\GitHubProject\picacg-qt\src
C:\Users\wumingjie\python-sdk\python3.10.16\python.exe -m pip install -r requirements.txt
```

**注意**：如果已在VSCode中配置了Python 3.10.16作为默认解释器，也可以直接使用：
```powershell
cd c:\Users\wumingjie\Documents\GitHubProject\picacg-qt\src
pip install -r requirements.txt
```

requirements.txt 内容：
```
PySide6==6.5.3
websocket-client==0.59.0
pillow
Pysocks
natsort
webdavclient3
tqdm
pysmb
lxml
httpx
httpx[http2]
httpx[socks]
```

### 2. 图片超分依赖（sr_ncnn_vulkan）

- **版本**：1.2.0
- **安装命令**：
  ```powershell
  pip install https://github.com/tonquer/waifu2x-vulkan/releases/download/v1.1.6/sr_ncnn_vulkan-1.2.0-cp36.cp37.cp38.cp39.cp310.cp311-none-win_amd64.whl
  ```

## 四、构建前准备

### 1. 下载数据库文件

```powershell
cd c:\Users\wumingjie\Documents\GitHubProject\picacg-qt\src
mkdir -p db
Invoke-WebRequest -Uri "https://github.com/bika-robot/picacg-database/releases/download/v1.5.3/book.db" -OutFile "db\book.db"
```

### 2. 准备图标文件

```powershell
cd c:\Users\wumingjie\Documents\GitHubProject\picacg-qt\src
Copy-Item ..\res\icon\icon.ico .
```

## 五、执行构建

运行以下命令执行构建：

```powershell
cd c:\Users\wumingjie\Documents\GitHubProject\picacg-qt\src
python -m nuitka `
  --onefile `
  --onefile-no-compression `
  --output-dir=dist `
  --output-filename=PicACG `
  --windows-console-mode=disable `
  --msvc=latest `
  --clang `
  --assume-yes-for-downloads `
  --windows-icon-from-ico=icon.ico `
  --plugin-enable=pyside6,upx --upx-binary="D:\upx-5.0.1-win64" `
  start.py
```

## 六、打包发布文件

构建完成后，执行以下命令打包发布文件：

```powershell
cd c:\Users\wumingjie\Documents\GitHubProject\picacg-qt\src

# 创建打包目录
$pkg = "bika"
Remove-Item -Recurse -Force $pkg -ErrorAction SilentlyContinue
New-Item $pkg -ItemType Directory

# 复制文件到打包目录
Move-Item "dist\PicACG.exe" "$pkg\start.exe"
Copy-Item -Recurse db $pkg\
Copy-Item ..\LICENSE $pkg\
Copy-Item ..\CHANGELOG $pkg\

# 压缩为7z格式
$TAG_NAME = "vX.X.X"  # 替换为实际版本号
$PACKAGE_PREFIX = "bika_$TAG_NAME"
$PACKAGENAME = "${PACKAGE_PREFIX}_windows_x64"
7z a -t7z -mx9 "$PACKAGENAME.7z" $pkg
```

## 七、无图片超分版本构建

如果需要构建不包含图片超分功能的版本，只需省略 `sr_ncnn_vulkan` 依赖的安装步骤即可。

## 八、环境变量

构建过程中使用的主要环境变量：

- `PACKAGENAME`: 打包文件名，格式为 `bika_${TAG_NAME}_windows_x64`
- `EXE_NAME`: 可执行文件名，为 `PicACG.exe`
- `TAG_NAME`: Git 标签名，表示版本号

## 九、常见问题解决

1. **构建失败提示缺少编译器**
   - 确保已安装 Visual Studio Build Tools 或完整的 Visual Studio，并包含 C++ 开发工具
   - 确保在构建前运行了 Visual Studio 的命令提示符环境

2. **找不到 UPX 工具**
   - 检查 UPX 的路径是否正确
   - 确保指定的路径包含 upx.exe 文件

3. **数据库文件下载失败**
   - 检查网络连接
   - 手动从 https://github.com/bika-robot/picacg-database/releases/tag/v1.5.3 下载 book.db 文件并放入 src/db 目录

4. **运行时缺少 DLL 文件**
   - 确保所有依赖项都已正确安装
   - 尝试重新安装 PySide6 等主要依赖

## 十、构建脚本封装

为了方便重复构建，可以将上述步骤封装为 PowerShell 脚本：

```powershell
# build_local.ps1

param(
    [string]$tagName = "dev",
    [bool]$withSR = $true,
    [string]$pythonVersion = "3.10"
)

# 设置环境变量
$env:PACKAGE_PREFIX = "bika_$tagName"
$env:PACKAGENAME = "${env:PACKAGE_PREFIX}_windows_x64"
$env:EXE_NAME = "PicACG.exe"
$upxPath = "D:\upx-5.0.1-win64"
$projectRoot = "c:\Users\wumingjie\Documents\GitHubProject\picacg-qt"
$srcDir = "$projectRoot\src"

# 进入源代码目录
Set-Location $srcDir

# 安装依赖
Write-Host "安装基础依赖..."
python -m pip install --upgrade pip
pip install nuitka
pip install -r requirements.txt

# 安装图片超分依赖
if ($withSR) {
    Write-Host "安装图片超分依赖..."
    pip install https://github.com/tonquer/waifu2x-vulkan/releases/download/v1.1.6/sr_ncnn_vulkan-1.2.0-cp36.cp37.cp38.cp39.cp310.cp311-none-win_amd64.whl
}

# 准备数据库文件
Write-Host "准备数据库文件..."
if (-not (Test-Path "db")) {
    New-Item "db" -ItemType Directory
}
if (-not (Test-Path "db\book.db")) {
    Invoke-WebRequest -Uri "https://github.com/bika-robot/picacg-database/releases/download/v1.5.3/book.db" -OutFile "db\book.db"
}

# 准备图标文件
if (-not (Test-Path "icon.ico")) {
    Copy-Item "..\res\icon\icon.ico" .
}

# 执行构建
Write-Host "开始构建..."
python -m nuitka `
  --onefile `
  --onefile-no-compression `
  --output-dir=dist `
  --output-filename=PicACG `
  --windows-console-mode=disable `
  --msvc=latest `
  --clang `
  --assume-yes-for-downloads `
  --windows-icon-from-ico=icon.ico `
  --plugin-enable=pyside6,upx --upx-binary="$upxPath" `
  start.py

# 打包发布文件
Write-Host "打包发布文件..."
$pkg = "bika"
Remove-Item -Recurse -Force $pkg -ErrorAction SilentlyContinue
New-Item $pkg -ItemType Directory
Move-Item "dist\$env:EXE_NAME" "$pkg\start.exe"
Copy-Item -Recurse db $pkg\
Copy-Item "..\LICENSE" $pkg\
Copy-Item "..\CHANGELOG" $pkg\
7z a -t7z -mx9 "$env:PACKAGENAME.7z" $pkg
Move-Item "${env:PACKAGENAME}.7z" "$projectRoot\"

Write-Host "构建完成！输出文件：$projectRoot\${env:PACKAGENAME}.7z"
```

使用方法：
```powershell
# 默认构建（带超分功能）
.uild_local.ps1 -tagName "v1.0.0"

# 无超分功能构建
.uild_local.ps1 -tagName "v1.0.0" -withSR $false
```

通过以上步骤，您应该能够在本地环境成功复现 GitHub Actions 中的构建过程，不再依赖于 CI/CD 平台。